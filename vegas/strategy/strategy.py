"""Strategy Layer for the Vegas backtesting engine.

This module provides the base Strategy class for implementing trading strategies
using an event-driven approach.
"""

from typing import List, Dict, Any, Optional
from dataclasses import dataclass
import pandas as pd


@dataclass
class Signal:
    """Trading signal generated by a strategy.

    Attributes:
        symbol: Trading symbol
        quantity: Signed quantity (positive = buy, negative = sell). Side is inferred from sign.
        order_type: Optional explicit order type. One of:
            "market", "limit", "stop", "stop_limit", "trail_stop", "trail_stop_limit" (case-insensitive).
            If omitted, the broker infers the type from provided fields (limit/stop/trailing) or defaults to market.
        limit_price: Price limit for LIMIT and for post-trigger STOP_LIMIT/TRAIL_STOP_LIMIT
        price: Alias for limit_price for backward compatibility
        stop_price: Static stop trigger for STOP/STOP_LIMIT
        trail_amount: Absolute trailing distance (mutually exclusive with trail_percent)
        trail_percent: Percent trailing distance, e.g., 0.1 for 10% (mutually exclusive with trail_amount)
        trigger_on_range: If True (default), evaluate triggers against bar high/low rather than close only

        Bracket/OCO parameters (optional, interpreted by broker when present):
        - take_profit_price: Price for take-profit LIMIT child
        - stop_loss_price: Stop trigger price for stop child (STOP or STOP_LIMIT when combined with stop_limit_price)
        - stop_limit_price: Limit price for stop-limit child when stop_loss_price is provided
        - stop_trail_amount: Trailing stop child absolute amount
        - stop_trail_percent: Trailing stop child percent (0.3 = 30%)
    """
    symbol: str
    quantity: float
    order_type: Optional[str] = None
    limit_price: Optional[float] = None
    price: Optional[float] = None  # backwards-compat alias for limit_price
    stop_price: Optional[float] = None
    trail_amount: Optional[float] = None
    trail_percent: Optional[float] = None
    trigger_on_range: bool = True
    # Bracket/OCO fields
    take_profit_price: Optional[float] = None
    stop_loss_price: Optional[float] = None
    stop_limit_price: Optional[float] = None
    stop_trail_amount: Optional[float] = None
    stop_trail_percent: Optional[float] = None


class Context:
    """Context for storing strategy state and parameters.
    
    This class provides a container for strategy-specific data that persists
    across trading days and strategy method calls.
    """
    
    def __init__(self):
        """Initialize an empty context."""
        self._portfolio = None
        self._engine = None  # Reference to the BacktestEngine
        self.current_date = None

        # Commission model configured by the strategy (defaults applied by engine/broker if not set)
        self._commission_model = None

        # Expose a commission helper namespace to strategies:
        # usage: context.set_commission(commission.PerShare(...))
        try:
            from vegas.broker.commission import commission as _commission_ns  # lazy import
            self.commission = _commission_ns
        except Exception:
            self.commission = None
    
    def set_portfolio(self, portfolio):
        """Set the portfolio reference (used internally).
        
        Args:
            portfolio: Portfolio object
        """
        self._portfolio = portfolio
        
    def set_engine(self, engine):
        """Set the backtest engine reference (used internally).
        
        Args:
            engine: BacktestEngine object
        """
        self._engine = engine

    def set_commission(self, commission_model) -> None:
        """Set the commission model for this strategy instance."""
        self._commission_model = commission_model

    def get_commission_model(self):
        """Return the configured commission model (or None if not set)."""
        return self._commission_model
    
    @property
    def portfolio(self):
        """Get the current portfolio state.
        
        Returns:
            Portfolio object
        """
        return self._portfolio
    
    def __setattr__(self, name, value):
        """Set an attribute in the context.
        
        Args:
            name: Attribute name
            value: Attribute value
        """
        self.__dict__[name] = value
    
    def __getattr__(self, name):
        """Get an attribute from the context.
        
        Args:
            name: Attribute name
            
        Returns:
            Attribute value
        
        Raises:
            AttributeError: If the attribute doesn't exist
        """
        if name in self.__dict__:
            return self.__dict__[name]
        raise AttributeError(f"Context has no attribute '{name}'")


class Strategy:
    """Base class for implementing event-driven trading strategies.
    
    This class provides an event-driven approach to implementing
    trading strategies. Subclass this class and implement the required
    methods to define your strategy.
    """
    
    def __init__(self):
        """Initialize the strategy."""
        self.context = Context()
    
    def initialize(self, context: Context) -> None:
        """Initialize the strategy with parameters.
        
        This method is called once at the beginning of the backtest.
        Override this method to set up strategy parameters and state.
        
        Args:
            context: Strategy context
        """
        pass
    
    def handle_data(self, context: Context, data: pd.DataFrame) -> List[Signal]:
        """Process market data and generate trading signals.
        
        This method is called for each time step in the event-driven backtest.
        Override this method to implement your strategy logic.
        
        Args:
            context: Strategy context
            data: Market data for current time step, containing all symbols
            
        Returns:
            List of trading signals
        """
        return []
    
    def before_trading_start(self, context: Context, data: pd.DataFrame) -> None:
        """Execute pre-trading logic.
        
        This method is called at the beginning of each trading day.
        Override this method to implement pre-trading day logic.
        
        Args:
            context: Strategy context
            data: Market data for the current day
        """
        pass
    
    def on_market_open(self, context: Context, data: pd.DataFrame, portfolio) -> None:
        """Execute logic at market open.
        
        This method is called at market open (9:30 AM) of each trading day.
        Override this method to implement specific market open logic.
        
        Args:
            context: Strategy context
            data: Market data for the current time
            portfolio: Portfolio object with current positions and cash
        """
        pass
    
    def on_market_close(self, context: Context, data: pd.DataFrame, portfolio) -> None:
        """Execute logic at market close.
        
        This method is called at market close (4:00 PM) of each trading day.
        Override this method to implement specific market close logic.
        
        Args:
            context: Strategy context
            data: Market data for the current time
            portfolio: Portfolio object with current positions and cash
        """
        pass
    
    def on_bar(self, context: Context, data: pd.DataFrame) -> None:
        """Execute logic when a new bar is received.
        
        This method is called when a new bar is available in event-driven mode.
        Override this method to implement bar-specific logic.
        
        Args:
            context: Strategy context
            data: Market data for the current bar
        """
        pass
    
    def on_tick(self, context: Context, data: pd.DataFrame) -> None:
        """Execute logic when a new tick is received.
        
        This method is called when a new tick is available in event-driven mode.
        Override this method to implement tick-specific logic.
        
        Args:
            context: Strategy context
            data: Market data for the current tick
        """
        pass
    
    def on_trade(self, context: Context, trade_event: Dict[str, Any], portfolio) -> None:
        """Execute logic when a trade is executed.
        
        This method is called when a trade from this strategy is executed.
        Override this method to implement trade-specific logic.
        
        Args:
            context: Strategy context
            trade_event: Dict with trade details
            portfolio: Portfolio object with current positions and cash
        """
        pass
    
    def analyze(self, context: Context, results: Dict[str, Any]) -> None:
        """Analyze backtest results.
        
        This method is called at the end of the backtest.
        Override this method to implement custom analysis.
        
        Args:
            context: Strategy context
            results: Backtest results
        """
        pass 